<!DOCTYPE html>

<head>
    <title>Filterbank</title>
    <link rel="icon" href="favicon.ico">
</head>

<body style="background-color:dimgrey;">
    <input type="file" accept="image/*" onchange="loadFile(event)">
    <br>
    <button type="button" onclick="drawOriginal()">Draw Original</button>
    <button type="button" onclick="resizeSmallSquare()">Resize Small Square</button>
    <button type="button" onclick="resizeLargeSquare()">Resize Large Square</button>
    <br>
    <button type="button" onclick="invert()">Invert</button>
    <button type="button" onclick="grayscale()">Grayscale</button>
    <button type="button" onclick="rotate()">Rotate</button>
    <br>
    <button type="button" onclick="filterbank()">Filterbank</button>
    <button type="button" onclick="filterbankColor()">Filterbank Colors</button>
    <br>
    <button type="button" onclick="filteringDirect()">Filterbank Direct</button>
    <br>
    <a>h_star <input id="h_star" placeholder="0.0, 0.0, ..."></a>
    <a>h <input id="h" placeholder="0.0, 0.0, ..."></a>
    <br>
    <a>g_star <input id="g_star" placeholder="0.0, 0.0, ..."></a>
    <a>g <input id="g" placeholder="0.0, 0.0, ..."></a>
    <br>
    <button onclick="setFilter()">Set Filter</button>
    <button onclick="defaultFilter()">Default Filter</button>
    <button onclick="showCurrentFilter()">Show Current Filter</button>
    <a id="currentFilter"></a>
    <br>
    <canvas id="canvas"></canvas>
    <canvas id="c2"></canvas>

    <script>
        // +------------------+
        // | Global Variables |
        // +------------------+
        // Drawing and image data handling
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        var img = new Image();
        var data;
        var imageData;
        // testing
        var c2 = document.getElementById("c2");
        var ctx2 = c2.getContext("2d");
        var data2;
        var imageData2;
        // Default Filter (Haarfilter: 1 / Math.sqrt(2))
        var h_star = [0.707, 0.707];
        var g_star = [-0.707, 0.707];
        var h = [0.707, 0.707];
        var g = [0.707, -0.707];
        // +----------------+
        // | MISC FUNCTIONS |
        // +----------------+
        function loadFile(event) {
            img.src = URL.createObjectURL(event.target.files[0]);
            img.onload = function() {
                drawOriginal();
            }
        };

        function drawOriginal() {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
        };

        function refreshData() {
            imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            data = imageData.data;
        };

        function resizeSmallSquare() {
            square = Math.min(img.width, img.height);
            canvas.width = square;
            canvas.height = square;
            ctx.drawImage(img, 0, 0);
        };

        function resizeLargeSquare() {
            square = Math.max(img.width, img.height);
            canvas.width = square;
            canvas.height = square;
            ctx.drawImage(img, 0, 0);
        };

        function invert() {
            refreshData();
            for (var i = 0; i < data.length; i += 4) {
                data[i] = 255 - data[i]; // red
                data[i + 1] = 255 - data[i + 1]; // green
                data[i + 2] = 255 - data[i + 2]; // blue
            }
            ctx.putImageData(imageData, 0, 0);
        };

        function grayscale() {
            refreshData();
            for (var i = 0; i < data.length; i += 4) {
                avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                data[i] = avg;
                data[i + 1] = avg;
                data[i + 2] = avg;
            }
            ctx.putImageData(imageData, 0, 0);
        };

        function rotate() {
            var tmp = new Image();
            tmp.src = canvas.toDataURL();
            tmp.onload = function() {
                var x = canvas.width / 2;
                var y = canvas.height / 2;
                var width = tmp.width;
                var height = tmp.height;
                var c = Math.abs(Math.cos(90 * Math.PI / 180));
                var s = Math.abs(Math.sin(90 * Math.PI / 180));

                canvas.width = height * s + width * c;
                canvas.height = height * c + width * s;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(90 * Math.PI / 180);
                ctx.drawImage(tmp, -width / 2, -height / 2, width, height);
                ctx.restore();
            }
        };

        /*
        function rotate() {
            var tmp = new Image();
            tmp.src = canvas.toDataURL();
            tmp.onload = function() {
                var x = canvas.width / 2;
                var y = canvas.height / 2;
                var width = tmp.width;
                var height = tmp.height;
                var c = Math.abs(Math.cos(90 * Math.PI / 180));
                var s = Math.abs(Math.sin(90 * Math.PI / 180));

                c2.width = height * s + width * c;
                c2.height = height * c + width * s;

                ctx2.clearRect(0, 0, canvas.width, canvas.height);
                ctx2.save();
                ctx2.translate(x, y);
                ctx2.rotate(90 * Math.PI / 180);
                ctx2.drawImage(tmp, -width / 2, -height / 2, width, height);
                ctx2.restore();
            }
        };*/

        function setFilter() {
            try {
                h_star = JSON.parse("[" + document.getElementById("h_star").value + "]");
                g_star = JSON.parse("[" + document.getElementById("g_star").value + "]");
                h = JSON.parse("[" + document.getElementById("h").value + "]");
                g = JSON.parse("[" + document.getElementById("g").value + "]");
            } catch {
                alert("Bad input!");
                defaultFilter();
            }
        };

        function defaultFilter() {
            h_star = [0.707, 0.707];
            g_star = [-0.707, 0.707];
            h = [0.707, 0.707];
            g = [0.707, -0.707];
        };

        function showCurrentFilter() {
            document.getElementById("currentFilter").innerHTML = "h_star: " + h_star + ", h: " + h + ", g_star: " + g_star + ", g: " + g;
        };

        function getGrayValues() {
            gray = [];
            for (var i = 0; i < data.length; i += 4) {
                gray[i / 4] = (data[i] + data[i + 1] + data[i + 2]) / 3;
            }
            return gray;
        };

        function setGrayValues(gray) {
            for (var i = 0; i < data.length; i += 4) {
                data[i] = gray[i / 4];
                data[i + 1] = gray[i / 4];
                data[i + 2] = gray[i / 4];
            }
            ctx.putImageData(imageData, 0, 0);
        };

        function getRedValues() {
            red = [];
            for (var i = 0; i < data.length; i += 4) {
                red[i / 4] = data[i];
            }
            return red;
        };

        function getGreenValues() {
            green = [];
            for (var i = 0; i < data.length; i += 4) {
                green[i / 4] = data[i + 1];
            }
            return green;
        };

        function getBlueValues() {
            blue = [];
            for (var i = 0; i < data.length; i += 4) {
                blue[i / 4] = data[i];
            }
            return blue;
        };

        function setRGB(red, green, blue) {
            for (var i = 0; i < data.length; i += 4) {
                data[i] = red[i / 4];
                data[i + 1] = green[i / 4];
                data[i + 2] = blue[i / 4];
            }
            ctx.putImageData(imageData, 0, 0);
        };

        function getRows(values, width, height) {
            var rows = [];
            for (var i = 0; i < width; i++) {
                rows[i] = [];
                for (var j = 0; j < height; j++) {
                    rows[i][j] = values[j + i * width];
                }
            }
            return rows;
        };

        function getCols(values, width, height) {
            var cols = [];
            for (var i = 0; i < width; i++) {
                cols[i] = [];
                for (var j = 0; j < height; j++) {
                    cols[i][j] = values[i + j * width];
                }
            }
            return cols;
        };
        /**
         * Convolution
         */
        function convolve(values, filter) {
            var result = [];//new Uint16Array(values.length);
            for (var i = 0; i < values.length; i++) {
                result[i] = 0;
                for (var j = 0; j < filter.length; j++) {
                    // Prevent out of bounds, no need for an "else" because it would be 0
                    if (i + j < values.length) {
                        result[i] += values[i + j] * filter[filter.length - 1 - j];
                    }
                }
            }
            return result;
        };

        function downAndUpsample(values) {
            for (var i = 0; i < values.length; i++) {
                if (i % 2 == 1) {
                    values[i] = 0;
                }
            }
            return values;
        };

        // +-------------+
        // | FILTERBANKS |
        // +-------------+

        function filterbank() {
            refreshData();
            var gray = getGrayValues();

            var width = canvas.width;
            var height = canvas.height;

            var rows = getRows(gray, width, height);
            var cols = getCols(gray, width, height);

            var lowpassRows = [];
            var lowpassCols = [];
            var highpassRows = [];
            var highpassCols = [];

            for (var i = 0; i < rows.length; i++) {
                lowpassRows[i] = convolve(rows[i], h_star);
                highpassRows[i] = convolve(rows[i], g_star);
            }

            for (var i = 0; i < cols.length; i++) {
                lowpassCols[i] = convolve(cols[i], h_star);
                highpassCols[i] = convolve(cols[i], g_star);
            }
            /*
            lowpassRows = downAndUpsample(lowpassRows);
            lowpassCols = downAndUpsample(lowpassCols);
            highpassRows = downAndUpsample(highpassRows);
            highpassCols = downAndUpsample(highpassCols);
            */

            for (var i = 0; i < rows.length; i++) {
                lowpassRows[i] = convolve(lowpassRows[i], h);
                highpassRows[i] = convolve(highpassRows[i], g);
            }

            for (var i = 0; i < cols.length; i++) {
                lowpassCols[i] = convolve(lowpassCols[i], h);
                highpassCols[i] = convolve(highpassCols[i], g);
            }

            for (var i = 0; i < height; i++) {
                for (var j = 0; j < width; j++) {
                    gray[i * width + j] = (lowpassRows[i][j] + highpassRows[i][j] /*+ lowpassCols[j][i] + highpassCols[j][i]*/ ) % 256;
                    // Only Rows ^= direct, so colums ^= rotated image
                }
            }

            setGrayValues(gray);
        };

        function filterbankColor() {
            refreshData();
            var red = getRedValues();
            var green = getGreenValues();
            var blue = getBlueValues();

            var width = canvas.width;
            var height = canvas.height;

            var redRows = getRows(red, width, height);
            var greenRows = getRows(green, width, height);
            var blueRows = getRows(blue, width, height);

            var redCols = getCols(red, width, height);
            var greenCols = getCols(green, width, height);
            var blueCols = getCols(blue, width, height);

            var lowpassRedRows = [];
            var lowpassRedCols = [];
            var lowpassGreenRows = [];
            var lowpassGreenCols = [];
            var lowpassBlueRows = [];
            var lowpassBlueCols = [];

            var highpassRedRows = [];
            var highpassRedCols = [];
            var highpassGreenRows = [];
            var highpassGreenCols = [];
            var highpassBlueRows = [];
            var highpassBlueCols = [];

            for (var i = 0; i < redRows.length; i++) {
                lowpassRedRows[i] = convolve(redRows[i], h_star);
                lowpassGreenRows[i] = convolve(greenRows[i], h_star);
                lowpassBlueRows[i] = convolve(blueRows[i], h_star);
                highpassRedRows[i] = convolve(redRows[i], g_star);
                highpassGreenRows[i] = convolve(greenRows[i], g_star);
                highpassBlueRows[i] = convolve(blueRows[i], g_star);
            }

            for (var i = 0; i < redCols.length; i++) {
                lowpassRedCols[i] = convolve(redCols[i], h_star);
                lowpassGreenCols[i] = convolve(greenCols[i], h_star);
                lowpassBlueCols[i] = convolve(blueCols[i], h_star);
                highpassRedCols[i] = convolve(redCols[i], g_star);
                highpassGreenCols[i] = convolve(greenCols[i], g_star);
                highpassBlueCols[i] = convolve(blueCols[i], g_star);
            }

            for (var i = 0; i < redRows.length; i++) {
                lowpassRedRows[i] = convolve(lowpassRedRows[i], h);
                lowpassGreenRows[i] = convolve(lowpassGreenRows[i], h);
                lowpassBlueRows[i] = convolve(lowpassBlueRows[i], h);
                highpassRedRows[i] = convolve(highpassRedRows[i], g);
                highpassGreenRows[i] = convolve(highpassGreenRows[i], g);
                highpassBlueRows[i] = convolve(highpassBlueRows[i], g);
            }

            for (var i = 0; i < redCols.length; i++) {
                lowpassRedCols[i] = convolve(lowpassRedCols[i], h);
                lowpassGreenCols[i] = convolve(lowpassGreenCols[i], h);
                lowpassBlueCols[i] = convolve(lowpassBlueCols[i], h);
                highpassRedCols[i] = convolve(highpassRedCols[i], g);
                highpassGreenCols[i] = convolve(highpassGreenCols[i], g);
                highpassBlueCols[i] = convolve(highpassBlueCols[i], g);
            }

            for (var i = 0; i < height; i++) {
                for (var j = 0; j < width; j++) {
                    red[i * width + j] = (lowpassRedRows[i][j] + highpassRedRows[i][j] + lowpassRedCols[j][i] + highpassRedCols[j][i]) % 256;
                    green[i * width + j] = (lowpassGreenRows[i][j] + highpassGreenRows[i][j] + lowpassGreenCols[j][i] + highpassGreenCols[j][i]) % 256;
                    blue[i * width + j] = (lowpassBlueRows[i][j] + highpassBlueRows[i][j] + lowpassBlueCols[j][i] + highpassBlueCols[j][i]) % 256;
                }
            }

            setRGB(red, green, blue);
        };

        function filteringDirect() {
            refreshData();
            var gray = getGrayValues();
            // Apply H*, G* Filter
            var lowpass = convolve(gray, h_star);
            var highpass = convolve(gray, g_star);
            // Down- and Upsample
            lowpass = downAndUpsample(lowpass);
            highpass = downAndUpsample(highpass);
            // Apply H, G Filter
            lowpass = convolve(lowpass, h);
            highpass = convolve(highpass, g);
            // Add the lowpass and highpass together
            for (var i = 0; i < lowpass.length; i++) {
                gray[i] = (lowpass[i] + highpass[i]);
            }
            // Use the grayvalues array to set the image data
            setGrayValues(gray);
        };

    </script>
</body>
