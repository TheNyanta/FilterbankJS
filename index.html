<!DOCTYPE html>

<head>
    <title>Filterbank</title>
    <link rel="icon" href="favicon.ico">
</head>

<body style="background-color:dimgrey;">
    <input type="file" accept="image/*" onchange="loadFile(event)">
    <br>
    <button type="button" onclick="drawOriginal()">Draw Original</button>
    <button type="button" onclick="invert()">Invert</button>
    <button type="button" onclick="grayscale()">Grayscale</button>
    <button type="button" onclick="rotate()">Rotate</button>
    <button type="button" onclick="filterbank()">Filterbank</button>
    <button type="button" onclick="filterbank2()">Filterbank2</button>
    <br>
    <a>h_star <input id="h_star" placeholder="0.0, 0.0, ..."></a>
    <a>h <input id="h" placeholder="0.0, 0.0, ..."></a>
    <br>
    <a>g_star <input id="g_star" placeholder="0.0, 0.0, ..."></a>
    <a>g <input id="g" placeholder="0.0, 0.0, ..."></a>
    <br>
    <button onclick="setFilter()">Set Filter</button>
    <button onclick="defaultFilter()">Default Filter</button>
    <button onclick="showCurrentFilter()">Show Current Filter</button>
    <a id="currentFilter"></a>
    <br>
    <canvas id="canvas"></canvas>

    <script>
        // +------------------+
        // | Global Variables |
        // +------------------+
        // Drawing and image data handling
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        var img = new Image();
        var data;
        var imageData;
        // Default Filter (Haar: 1 / Math.sqrt(2))
        var h_star = [0.707, 0.707];
        var g_star = [-0.707, 0.707];
        var h = [0.707, 0.707];
        var g = [0.707, -0.707];

        // +-----------+
        // | Functions |
        // +-----------+
        function loadFile(event) {
            img.src = URL.createObjectURL(event.target.files[0]);
            img.onload = function() {
                drawOriginal();
            }
        };

        function drawOriginal() {
            // for easy mode rotation
            max = Math.max(img.width, img.height);
            canvas.width = max;
            canvas.height = max;
            ctx.drawImage(img, 0, 0);
        };

        function refreshData() {
            imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            data = imageData.data;
        };

        function invert() {
            refreshData();
            for (var i = 0; i < data.length; i += 4) {
                data[i] = 255 - data[i]; // red
                data[i + 1] = 255 - data[i + 1]; // green
                data[i + 2] = 255 - data[i + 2]; // blue
            }
            ctx.putImageData(imageData, 0, 0);
        };

        function grayscale() {
            refreshData();
            for (var i = 0; i < data.length; i += 4) {
                avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                data[i] = avg;
                data[i + 1] = avg;
                data[i + 2] = avg;
            }
            ctx.putImageData(imageData, 0, 0);
        };

        function rotate() {
            var tmp = new Image();
            tmp.src = canvas.toDataURL();
            tmp.onload = function() {
                var x = canvas.width / 2;
                var y = canvas.height / 2;
                var width = tmp.width;
                var height = tmp.height;
                var c = Math.abs(Math.cos(90 * Math.PI / 180));
                var s = Math.abs(Math.sin(90 * Math.PI / 180));

                canvas.width = height * s + width * c;
                canvas.height = height * c + width * s;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(90 * Math.PI / 180);
                ctx.drawImage(tmp, -width / 2, -height / 2, width, height);
                ctx.restore();
            }
        };

        function getGrayValues() {
            gray = [];
            for (var i = 0; i < data.length; i += 4) {
                gray[i / 4] = (data[i] + data[i + 1] + data[i + 2]) / 3;
            }
            return gray;
        };

        function setGrayValues(gray) {
            for (var i = 0; i < data.length; i += 4) {
                data[i] = gray[i / 4];
                data[i + 1] = gray[i / 4];
                data[i + 2] = gray[i / 4];
            }
            ctx.putImageData(imageData, 0, 0);
        };

        function getRedValues() {
            red = [];
            for (var i = 0; i < data.length; i += 4) {
                red[i / 4] = data[i];
            }
            return red;
        };

        function getGreenValues() {
            green = [];
            for (var i = 0; i < data.length; i += 4) {
                green[i / 4] = data[i + 1];
            }
            return green;
        };

        function getBlueValues() {
            blue = [];
            for (var i = 0; i < data.length; i += 4) {
                blue[i / 4] = data[i];
            }
            return blue;
        };

        function setRGB(red, green, blue) {
            for (var i = 0; i < data.length; i += 4) {
                data[i] = red[i / 4];
                data[i + 1] = green[i / 4];
                data[i + 2] = blue[i / 4];
            }
            ctx.putImageData(imageData, 0, 0);
        };

        function convolve(values, filter) {
            var result = new Uint16Array(values.length);
            for (var i = 0; i < values.length; i++) {
                for (var j = 0; j < filter.length; j++) {
                    // Prevent out of bounds, no need for an "else" because it would be 0
                    if (i + j < values.length) {
                        result[i] += values[i + j] * filter[filter.length - 1 - j];
                    }
                }
            }
            return result;
        };

        function downAndUpsample(values) {
            for (var i = 0; i < values.length; i++) {
                if (i % 2 == 1) {
                    values[i] = 0;
                }
            }
            return values;
        };

        function filterbank() {
            refreshData();
            var gray = getGrayValues();

            var width = canvas.width;
            var height = canvas.height;

            var rows = getRows(gray, width, height);
            var cols = getCols(gray, width, height);

            var lowpassRows = [];
            var lowpassCols = [];
            var highpassRows = [];
            var highpassCols = [];

            for (var i = 0; i < rows.length; i++) {
                lowpassRows[i] = convolve(rows[i], h_star);
                highpassRows[i] = convolve(rows[i], g_star);
            }

            for (var i = 0; i < cols.length; i++) {
                lowpassCols[i] = convolve(cols[i], h_star);
                highpassCols[i] = convolve(cols[i], g_star);
            }
            /*
            lowpassRows = downAndUpsample(lowpassRows);
            lowpassCols = downAndUpsample(lowpassCols);
            highpassRows = downAndUpsample(highpassRows);
            highpassCols = downAndUpsample(highpassCols);
            */

            for (var i = 0; i < rows.length; i++) {
                lowpassRows[i] = convolve(lowpassRows[i], h);
                highpassRows[i] = convolve(highpassRows[i], g);
            }

            for (var i = 0; i < cols.length; i++) {
                lowpassCols[i] = convolve(lowpassCols[i], h);
                highpassCols[i] = convolve(highpassCols[i], g);
            }
            /*

                        console.log(lowpassRows)
                        console.log(lowpassCols)
                        console.log(highpassRows)
                        console.log(highpassCols)
                        
                        console.log(gray.length % width)
                        console.log(Math.floor(gray.length / width))

                        /*
                        for (var i = 0; i < gray.length; i++) {
                            var x = i % width;
                            var y = Math.floor(i / width);
                            gray[i] = lowpassRows[x][y] + highpassRows[x][y]; //+ lowpassCols[y][x] + highpassCols[y][x];
                        }*/

            for (var i = 0; i < height; i++) {
                for (var j = 0; j < width; j++) {
                    gray[i * width + j] = lowpassRows[i][j] + highpassRows[i][j] // + lowpassCols[j][i] + highpassCols[j][i];
                }
            }

            setGrayValues(gray);
        };

        function filterbank2() {
            // Convert to grayscale and save grayvalues in an extra array
            refreshData();
            var gray = getGrayValues();
            // Apply H*, G* Filter
            var lowpass = [];
            var highpass = [];
            // Do the Convolution
            for (var i = 0; i < gray.length; i++) {
                // Set to 0 so you can use "+=" for the convolusion (else you would get "NaN")
                lowpass[i] = 0;
                highpass[i] = 0;
                for (var j = 0; j < h.length; j++) {
                    // Prevent out of bounds, no need for an "else" because it would be 0
                    if (i + j < gray.length) {
                        lowpass[i] += gray[i + j] * h_star[h.length - j - 1];
                        highpass[i] += gray[i + j] * g_star[h.length - j - 1];
                    }
                }
            }
            // Apply H, G Filter
            var lowpass2 = [];
            var highpass2 = [];
            for (var i = 0; i < lowpass2.length; i++) {
                for (var j = 0; j < h.length; j++) {
                    // Prevent out of bounds, no need for an "else" because it would be 0
                    if (i + j < lowpass2.length) {
                        lowpass2[i] += lowpass2[i + j] * h[h.length - j - 1];
                        highpass2[i] += highpass2[i + j] * g[h.length - j - 1];
                    }
                }
            }
            // Add the lowpass and highpass together
            for (var i = 0; i < lowpass2.length; i++) {
                gray[i] = lowpass2[i] + highpass2[i];
            }
            // Use the grayvalues array to set the image data
            setGrayValues(gray);
        };

        function filterbankColor() {
            refreshData();
            var red = getRedValues();
            var green = getGreenValues();
            var blue = getBlueValues();

            var w = canvas.width;
            var height = canvas.height;

            var redRows = getRows(red, w, height);
            var greenRows = getRows(green, w, height);
            var blueRows = getRows(blue, w, height);

            var redCols = getCols(red, w, height);
            var greenCols = getCols(green, w, height);
            var blueCols = getCols(blue, w, height);

            var lowpassRedRows = [];
            var lowpassRedCols = [];
            var lowpassGreenRows = [];
            var lowpassGreenCols = [];
            var lowpassBlueRows = [];
            var lowpassBlueCols = [];

            var highpassRedRows = [];
            var highpassRedCols = [];
            var highpassGreenRows = [];
            var highpassGreenCols = [];
            var highpassBlueRows = [];
            var highpassBlueCols = [];

            for (var i = 0; i < redRows.length; i++) {
                lowpassRedRows[i] = convolve(redRows[i], h_star);
                lowpassGreenRows[i] = convolve(greenRows[i], h_star);
                lowpassBlueRows[i] = convolve(blueRows[i], h_star);
                highpassRedRows[i] = convolve(redRows[i], g_star);
                highpassGreenRows[i] = convolve(greenRows[i], g_star);
                highpassBlueRows[i] = convolve(blueRows[i], g_star);
            }

            for (var i = 0; i < redCols.length; i++) {
                lowpassRedCols[i] = convolve(redCols[i], h_star);
                lowpassGreenCols[i] = convolve(greenCols[i], h_star);
                lowpassBlueCols[i] = convolve(blueCols[i], h_star);
                highpassRedCols[i] = convolve(redCols[i], g_star);
                highpassGreenCols[i] = convolve(greenCols[i], g_star);
                highpassBlueCols[i] = convolve(blueCols[i], g_star);
            }

            for (var i = 0; i < redRows.length; i++) {
                lowpassRedRows[i] = convolve(lowpassRedRows[i], h);
                lowpassGreenRows[i] = convolve(lowpassGreenRows[i], h);
                lowpassBlueRows[i] = convolve(lowpassBlueRows[i], h);
                highpassRedRows[i] = convolve(highpassRedRows[i], g);
                highpassGreenRows[i] = convolve(highpassGreenRows[i], g);
                highpassBlueRows[i] = convolve(highpassBlueRows[i], g);
            }

            for (var i = 0; i < redCols.length; i++) {
                lowpassRedCols[i] = convolve(lowpassRedCols[i], h);
                lowpassGreenCols[i] = convolve(lowpassGreenCols[i], h);
                lowpassBlueCols[i] = convolve(lowpassBlueCols[i], h);
                highpassRedCols[i] = convolve(highpassRedCols[i], g);
                highpassGreenCols[i] = convolve(highpassGreenCols[i], g);
                highpassBlueCols[i] = convolve(highpassBlueCols[i], g);
            }
            /* TODO: Fix
            red = lowpassRedRows + highpassRedRows + lowpassRedCols + highpassRedCols;
            green = lowpassGreenRows + highpassGreenRows + lowpassGreenCols + highpassGreenCols;
            blue = lowpassBlueRows + highpassBlueRows + lowpassBlueCols + highpassBlueCols;
            */

            setRGB(red, green, blue);
        };

        function setFilter() {
            try {
                h_star = JSON.parse("[" + document.getElementById("h_star").value + "]");
                g_star = JSON.parse("[" + document.getElementById("g_star").value + "]");
                h = JSON.parse("[" + document.getElementById("h").value + "]");
                g = JSON.parse("[" + document.getElementById("g").value + "]");
            } catch {
                alert("Bad input!");
                defaultFilter();
            }
        };

        function defaultFilter() {
            h_star = [0.707, 0.707];
            g_star = [-0.707, 0.707];
            h = [0.707, 0.707];
            g = [0.707, -0.707];
        };

        function showCurrentFilter() {
            document.getElementById("currentFilter").innerHTML = "h_star: " + h_star + ", h: " + h + ", g_star: " + g_star + ", g: " + g;
        };

    </script>
</body>
