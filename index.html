<!DOCTYPE html>

<head>
    <title>Filterbank</title>
    <link rel="icon" href="favicon.ico">
</head>

<body style="background-color:dimgrey;">
    <input type="file" accept="image/*" onchange="loadFile(event)">
    <br>
    <button type="button" onclick="drawOriginal()">Draw Original</button>
    <button type="button" onclick="invert()">Invert</button>
    <button type="button" onclick="grayscale()">Grayscale</button>
    <button type="button" onclick="filterbank()">Filterbank</button>
    <button type="button" onclick="filterbank2()">Filterbank2</button>
    <button type="button" onclick="rotateCanvas()">Rotate</button>
    <br>
    <a>h_star <input id="h_star" placeholder="0.0, 0.0, ..."></a>
    <a>h <input id="h" placeholder="0.0, 0.0, ..."></a>
    <br>
    <a>g_star <input id="g_star" placeholder="0.0, 0.0, ..."></a>
    <a>g <input id="g" placeholder="0.0, 0.0, ..."></a>
    <br>
    <button onclick="setFilter()">Set Filter</button>
    <button onclick="defaultFilter()">Default Filter</button>
    <button onclick="showCurrentFilter()">Show Current Filter</button>
    <a id="currentFilter"></a>
    <br>
    <canvas id="canvas"></canvas>

    <script>
        // +------------------+
        // | Global Variables |
        // +------------------+
        // Drawing and image data handling
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        var img = new Image();
        var data;
        var imageData;
        var grayValues = [];//new Uint8ClampedArray();
        // Filters
        var h_star = [0.707, 0.707];
        var g_star = [-0.707, 0.707];
        var h = [0.707, 0.707];
        var g = [0.707, -0.707];
        
        // +-----------+
        // | Functions |
        // +-----------+
        function loadFile(event) {
            img.src = URL.createObjectURL(event.target.files[0]);
        };

        function drawOriginal() {
            canvas.height = img.height;
            canvas.width = img.width;
            ctx.drawImage(img, 0, 0);
        };
        
        function rotateCanvas() {
            //var height = canvas.height;
            //var width = canvas.width;
            //canvas.width = Math.max(height, width);
            //canvas.height = Math.max(height, width);
            //canvas.width = height;
            //canvas.height = width;
            ctx.rotate(90 * Math.PI / 180);
            ctx.drawImage(img, 0,0);
        };

        function refreshData() {
            imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            data = imageData.data;
        };

        function invert() {
            refreshData();
            for (var i = 0; i < data.length; i += 4) {
                data[i] = 255 - data[i]; // red
                data[i + 1] = 255 - data[i + 1]; // green
                data[i + 2] = 255 - data[i + 2]; // blue
            }
            ctx.putImageData(imageData, 0, 0);
        };

        function grayscale() {
            refreshData();
            for (var i = 0; i < data.length; i += 4) {
                avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                data[i] = avg;
                data[i + 1] = avg;
                data[i + 2] = avg;
            }
            ctx.putImageData(imageData, 0, 0);
        };

        function getGrayValues() {
            for (var i = 0; i < data.length; i += 4) {
                avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                grayValues[i / 4] = avg;
            }
        };
        
        function getRedValues() {
            red = [];
            for (var i = 0; i < data.length; i += 4) {
                red[i / 4] = data[i];
            }
            return red;
        };
        
        function getGreenValues() {
            green = [];
            for (var i = 0; i < data.length; i += 4) {
                green[i / 4] = data[i+1];
            }
            return green;
        };
        
        function getBlueValues() {
            blue = [];
            for (var i = 0; i < data.length; i += 4) {
                blue[i / 4] = data[i];
            }
            return blue;
        };        
      
        function setGrayValues() {
            for (var i = 0; i < data.length; i += 4) {
                var gray = grayValues[i / 4]
                data[i] = gray;
                data[i + 1] = gray;
                data[i + 2] = gray;
            }
            ctx.putImageData(imageData, 0, 0);
        };
        
        function setImageDataValues(red, green, blue) {
            for (var i = 0; i < data.length; i += 4) {
                data[i] = red[i/4];
                data[i + 1] = green[i/4];
                data[i + 2] = blue[i/4];
            }
            ctx.putImageData(imageData, 0, 0);
        };
        
        function convolve(signal, filter) {
            var result = [];
            for (var i = 0; i < signal.length; i++) {
                for (var j = 0; j < filter.length; j++) {
                    // Prevent out of bounds, no need for an "else" because it would be 0
                    if (i + j < signal.length) {
                        result[i] += signal[i + j] * filter[filter.length-1 - j];
                    }
                }
            }
        };

        function filterbank() {
            // Convert to grayscale and save grayvalues in an extra array
            refreshData();
            getGrayValues();
            // Apply H*, G* Filter and do downsampling 
            var lowpassDownsampled = [];
            var highpassDownsampled = [];
            // Do the Convolution and downsampling together by skipping the calculation for the odd numbers which would get dropped by downsampling
            for (var i = 0; i < grayValues.length; i += 2) {
                // Set to 0 so you can use "+=" for the convolusion (else you would get "NaN")
                lowpassDownsampled[Math.floor(i / 2)] = 0;
                highpassDownsampled[Math.floor(i / 2)] = 0;
                for (var j = 0; j < h.length; j++) {
                    // Prevent out of bounds, no need for an "else" because it would be 0
                    if (i + j < grayValues.length) {
                        lowpassDownsampled[Math.floor(i / 2)] += grayValues[i + j] * h_star[h.length - j - 1];
                        highpassDownsampled[Math.floor(i / 2)] += grayValues[i + j] * g_star[h.length - j - 1];
                    }
                }
            }
            // Upsampling
            var lowpassUpsampled = [];
            var highpassUpsampled = [];
            for (var i = 0; i < grayValues.length; i++) {
                if (i % 2 == 0) {
                    lowpassUpsampled[i] = lowpassDownsampled[Math.floor(i / 2)];
                    highpassUpsampled[i] = highpassDownsampled[Math.floor(i / 2)];
                } else {
                    // Fill in zeros at odd indices
                    lowpassUpsampled[i] = 0;
                    highpassUpsampled[i] = 0;
                }
            }
            // Apply H, G Filter
            for (var i = 0; i < lowpassUpsampled.length; i++) {
                for (var j = 0; j < h.length; j++) {
                    // Prevent out of bounds, no need for an "else" because it would be 0
                    if (i + j < lowpassUpsampled.length) {
                        lowpassUpsampled[i] += lowpassUpsampled[i + j] * h[h.length - j - 1];
                        highpassUpsampled[i] += highpassUpsampled[i + j] * g[h.length - j - 1];
                    }
                }
            }
            // Add the lowpass and highpass together
            for (var i = 0; i < lowpassUpsampled.length; i++) {
                grayValues[i] = lowpassUpsampled[i] + highpassUpsampled[i];
            }
            // Use the grayvalues array to set the image data
            setGrayValues();
        };
        function filterbank2() {
            // Convert to grayscale and save grayvalues in an extra array
            refreshData();
            getGrayValues();
            // Apply H*, G* Filter
            var lowpass = [];
            var highpass = [];
            // Do the Convolution
            for (var i = 0; i < grayValues.length; i++) {
                // Set to 0 so you can use "+=" for the convolusion (else you would get "NaN")
                lowpass[i] = 0;
                highpass[i] = 0;
                for (var j = 0; j < h.length; j++) {
                    // Prevent out of bounds, no need for an "else" because it would be 0
                    if (i + j < grayValues.length) {
                        lowpass[i] += grayValues[i + j] * h_star[h.length - j - 1];
                        highpass[i] += grayValues[i + j] * g_star[h.length - j - 1];
                    }
                }
            }
            // Apply H, G Filter
            var lowpass2 = [];
            var highpass2 = [];
            for (var i = 0; i < lowpass2.length; i ++) {
                for (var j = 0; j < h.length; j++) {
                    // Prevent out of bounds, no need for an "else" because it would be 0
                    if (i + j < lowpass2.length) {
                        lowpass2[i] += lowpass2[i + j] * h[h.length - j - 1];
                        highpass2[i] += highpass2[i + j] * g[h.length - j - 1];
                    }
                }
            }
            // Add the lowpass and highpass together
            for (var i = 0; i < lowpass2.length; i++) {
                grayValues[i] = lowpass2[i] + highpass2[i];
            }
            // Use the grayvalues array to set the image data
            setGrayValues();
        };

        function testRGB() {
            refreshData();
            red = getRedValues();
            green = getGreenValues();
            blue = getBlueValues();
            
            setImageDataValues(blue, green, red); // switched blue and red
         };
        
        function setFilter() {
            try {
                h_star = JSON.parse("[" + document.getElementById("h_star").value + "]");
                g_star = JSON.parse("[" + document.getElementById("g_star").value + "]");
                h = JSON.parse("[" + document.getElementById("h").value + "]");
                g = JSON.parse("[" + document.getElementById("g").value + "]");
            } catch {
                alert("Bad input!");
                defaultFilter();
            }
        };

        function defaultFilter() {
            h_star = [0.707, 0.707];
            g_star = [-0.707, 0.707];
            h = [0.707, 0.707];
            g = [0.707, -0.707];
        };

        function showCurrentFilter() {
            document.getElementById("currentFilter").innerHTML = "h_star: " + h_star + ", h: " + h + ", g_star: " + g_star + ", g: " + g;
        };

    </script>
</body>
