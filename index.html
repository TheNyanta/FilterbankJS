<!DOCTYPE html>

<head>
    <title>Filterbank</title>
    <link rel="icon" href="favicon.ico">
</head>

<body style="background-color:dimgrey;">
    <input type="file" accept="image/*" onchange="loadFile(event)">
    <br>
    <button type="button" onclick="drawOriginal()">Draw Original</button>
    <button type="button" onclick="invert()">Invert</button>
    <button type="button" onclick="grayscale()">Grayscale</button>
    <br>
    <button type="button" onclick="filteringDirectGray()">Filterbank Direct Gray</button>
    <button type="button" onclick="filterbankDirectColor()">Filterbank Direct Colors</button>
    <br>
    <a>h_star <input id="h_star" placeholder="0.0, 0.0, ..."></a>
    <a>h <input id="h" placeholder="0.0, 0.0, ..."></a>
    <br>
    <a>g_star <input id="g_star" placeholder="0.0, 0.0, ..."></a>
    <a>g <input id="g" placeholder="0.0, 0.0, ..."></a>
    <br>
    <button onclick="setFilter()">Set Filter</button>
    <button onclick="defaultFilter()">Default Filter</button>
    <button onclick="showCurrentFilter()">Show Current Filter</button>
    <a id="currentFilter"></a>
    <br>
    <canvas id="canvas"></canvas>

    <script>
        // +------------------+
        // | GLOBAL VARIABLES |
        // +------------------+

        // Drawing and image data handling
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        var img = new Image();
        var data;
        var imageData;

        // Default Filter (Haarfilter: 1 / Math.sqrt(2))
        var h_star = [0.707, 0.707];
        var g_star = [-0.707, 0.707];
        var h = [0.707, 0.707];
        var g = [0.707, -0.707];

        // +-----------+
        // | FUNCTIONS |
        // +-----------+

        function loadFile(event) {
            img.src = URL.createObjectURL(event.target.files[0]);
            img.onload = function() {
                drawOriginal();
            }
        };

        function drawOriginal() {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
        };

        function refreshData() {
            imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            data = imageData.data;
        };

        function invert() {
            refreshData();
            for (var i = 0; i < data.length; i += 4) {
                data[i] = 255 - data[i]; // red
                data[i + 1] = 255 - data[i + 1]; // green
                data[i + 2] = 255 - data[i + 2]; // blue
            }
            ctx.putImageData(imageData, 0, 0);
        };

        function grayscale() {
            refreshData();
            for (var i = 0; i < data.length; i += 4) {
                avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                data[i] = avg;
                data[i + 1] = avg;
                data[i + 2] = avg;
            }
            ctx.putImageData(imageData, 0, 0);
        };

        function setFilter() {
            try {
                h_star = JSON.parse("[" + document.getElementById("h_star").value + "]");
                g_star = JSON.parse("[" + document.getElementById("g_star").value + "]");
                h = JSON.parse("[" + document.getElementById("h").value + "]");
                g = JSON.parse("[" + document.getElementById("g").value + "]");
            } catch {
                alert("Bad input!");
                defaultFilter();
            }
        };

        function defaultFilter() {
            h_star = [0.707, 0.707];
            g_star = [-0.707, 0.707];
            h = [0.707, 0.707];
            g = [0.707, -0.707];
        };

        function showCurrentFilter() {
            document.getElementById("currentFilter").innerHTML = "h_star: " + h_star + ", h: " + h + ", g_star: " + g_star + ", g: " + g;
        };

        // +------------------------+
        // | CANVAS DATA CONVERTING |
        // +------------------------+

        function getGrayValues() {
            gray = [];
            for (var i = 0; i < data.length; i += 4) {
                gray[i / 4] = (data[i] + data[i + 1] + data[i + 2]) / 3;
            }
            return gray;
        };

        function setGrayValues(gray) {
            for (var i = 0; i < data.length; i += 4) {
                data[i] = gray[i / 4];
                data[i + 1] = gray[i / 4];
                data[i + 2] = gray[i / 4];
            }
            ctx.putImageData(imageData, 0, 0);
        };

        function getRedValues() {
            red = [];
            for (var i = 0; i < data.length; i += 4) {
                red[i / 4] = data[i];
            }
            return red;
        };

        function getGreenValues() {
            green = [];
            for (var i = 0; i < data.length; i += 4) {
                green[i / 4] = data[i + 1];
            }
            return green;
        };

        function getBlueValues() {
            blue = [];
            for (var i = 0; i < data.length; i += 4) {
                blue[i / 4] = data[i];
            }
            return blue;
        };

        function setRGB(red, green, blue) {
            for (var i = 0; i < data.length; i += 4) {
                data[i] = red[i / 4];
                data[i + 1] = green[i / 4];
                data[i + 2] = blue[i / 4];
            }
            ctx.putImageData(imageData, 0, 0);
        };

        // +--------------+
        // | CONVOLUTION  |
        // +--------------+

        function convolve(values, filter) {
            var result = []; //new Uint16Array(values.length);
            for (var i = 0; i < values.length; i++) {
                result[i] = 0;
                for (var j = 0; j < filter.length; j++) {
                    // Prevent out of bounds, no need for an "else" because it would be 0
                    if (i + j < values.length) {
                        result[i] += values[i + j] * filter[filter.length - 1 - j];
                    }
                }
            }
            return result;
        };

        // +-----------------------+
        // | DOWN- AND UPSAMPLING  |
        // +-----------------------+

        function downAndUpsample(values) {
            for (var i = 0; i < values.length; i++) {
                if (i % 2 == 1) {
                    values[i] = 0;
                }
            }
            return values;
        };

        // +-------------+
        // | FILTERBANKS |
        // +-------------+

        function filteringDirectGray() {
            refreshData();
            var gray = getGrayValues();
            // Apply H*, G* Filter
            var lowpass = convolve(gray, h_star);
            var highpass = convolve(gray, g_star);
            // Down- and Upsample
            lowpass = downAndUpsample(lowpass);
            highpass = downAndUpsample(highpass);
            // Apply H, G Filter
            lowpass = convolve(lowpass, h);
            highpass = convolve(highpass, g);
            // Undo the "-1" time delay
            lowpass.unshift(lowpass.pop());
            highpass.unshift(highpass.pop());
            // Add the lowpass and highpass together
            for (var i = 0; i < lowpass.length; i++) {
                gray[i] = (lowpass[i] + highpass[i]);
            }
            // Use the grayvalues array to set the image data
            setGrayValues(gray);
        };

        function filterbankDirectColor() {
            refreshData();
            var red = getRedValues();
            var green = getGreenValues();
            var blue = getBlueValues();
            // Apply H*, G* Filter
            var lowpassRed = convolve(red, h_star);
            var lowpassGreen = convolve(green, h_star);;
            var lowpassBlue = convolve(blue, h_star);
            var highpassRed = convolve(red, g_star);
            var highpassGreen = convolve(green, g_star);
            var highpassBlue = convolve(blue, g_star);
            // Down- and Upsample
            lowpassRed = downAndUpsample(lowpassRed);
            lowpassGreen = downAndUpsample(lowpassGreen);
            lowpassBlue = downAndUpsample(lowpassBlue);
            highpassRed = downAndUpsample(highpassRed);
            highpassGreen = downAndUpsample(highpassGreen);
            highpassBlue = downAndUpsample(highpassBlue);
            // Apply H, G Filter
            lowpassRed = convolve(lowpassRed, h);
            lowpassGreen = convolve(lowpassGreen, h);
            lowpassBlue = convolve(lowpassBlue, h);
            highpassRed = convolve(highpassRed, g);
            highpassGreen = convolve(highpassGreen, g);
            highpassBlue = convolve(highpassBlue, g);
            // Undo the "-1" time delay
            lowpassRed.unshift(lowpassRed.pop());
            lowpassGreen.unshift(lowpassGreen.pop());
            lowpassBlue.unshift(lowpassBlue.pop());
            highpassRed.unshift(highpassRed.pop());
            highpassGreen.unshift(highpassGreen.pop());
            highpassBlue.unshift(highpassBlue.pop());
            // Add the lowpass and highpass together
            for (var i = 0; i < lowpassRed.length; i++) {
                red[i] = (lowpassRed[i] + highpassRed[i]);
                green[i] = (lowpassGreen[i] + highpassGreen[i]);
                blue[i] = (lowpassBlue[i] + highpassBlue[i]);
            }
            // Use the rgb data arrays to set the image data
            setRGB(red, green, blue);
        };

    </script>
</body>
